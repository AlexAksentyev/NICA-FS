INCLUDE 'bin/support/main';

PROCEDURE RUN;
  VARIABLE WHERE 100;
  VARIABLE HZ1 1; VARIABLE HZ2 1;
  VARIABLE QF 1; VARIABLE QD 1;
  VARIABLE I 1; VARIABLE LQ 1;
  VARIABLE MU 100 2; VARIABLE OBJ 1;
  VARIABLE A 100 2; VARIABLE B 100 2;
  VARIABLE G 100 2; VARIABLE R 100 2;
  VARIABLE F 100 6;

  PROCEDURE CELL QF QD L;
    QUAD L/2 0 QD; DL .1;
    RBEND 1.94 4.5*DEGRAD 0; DL .1;
    QUAD L 0 QF; DL .1;
    RBEND 1.94 4.5*DEGRAD 0; DL .1;
    QUAD L/2 0 QD;
  ENDPROCEDURE;
  PROCEDURE SUPER QF QD L;
    CELL QF QD L;
    CELL QF QD L;
    CELL QF QD L;
  ENDPROCEDURE;
  PROCEDURE FODO QF QD L;
    QUAD L/2 0 QD; DL .1;
    QUAD L 0 QF; DL .1;
    QUAD L/2 0 QD;
  ENDPROCEDURE;
  PROCEDURE SUPER_FODO QF QD L;
    FODO QF QD L;
    FODO QF QD L;
    FODO QF QD L;
  ENDPROCEDURE;


  DIRSET WHERE 'dada/NEW_RING/' 1;
  GROUTF 'img/dump/TR' 1;

  OV 3 2 2;
  SET_FOR_PROTONS HZ1 HZ2 QF QD;
  QF := 0; QD :=0;

  SB .15 .15 0 .15 .15 0 0 0 0 0 0;
  QF := 1; QD := -1;

  UM; CR; ER 1 3 1 3 1 1 1 1;
  BP; DL .2;
  SUPER_FODO QF QD .2;
  EP;
  PG -1 -2;
  TP MU;
  WRITE 6 MU(1) MU(2);

{TRYING TO OPTIMIZE THE QUADRUPOLE STRENGTH TO GET STABLE ORBITAL MOTION}
IF TRUE;
  FIT QF QD;
  UM; CR; ER 1 3 1 3 1 1 1 1;
  BP; DL .2;
  SUPER QF QD .2;
  EP;
  PG -1 -2;
  TP MU;
  OBJ := ABS(ME(1,2)) + ABS(ME(3,4));
  WRITE 6 OBJ;
  WRITE 6 MU(1) MU(2);
  ENDFIT 1E-5 1000 1 OBJ;
  WRITE 6 '########## ' QF QD;
ENDIF;
  
  WRITE 6 'B\RHO = '&ST(CONS(CHIM));
  
  { FIT QF QD; }
  {   UM; CELL QF QD; }
  {   TP MU; }
  {   WRITE 6 'MU(1)          MU(2)          ' }
  {            SF(MU(1), '(E15.7)')&SF(MU(2), '(E15.7)'); }
  {   GT MAP F MU A B G R;  }
  {   OBJ := SQRT(SQR(MU(1)-PI/2) + SQR(MU(2)-PI/2)); }
  { ENDFIT 1E-5 1000 1 OBJ; }

ENDPROCEDURE;
RUN; END;
