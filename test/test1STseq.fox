INCLUDE 'bin/setups/FIRST-ST/SEQFULL';

PROCEDURE INJECT NUM;
  VARIABLE X 100; VARIABLE I 1;
  X := LINSPACE(-5E-3, 5E-3, NUM);
  SR 0 0 0 0 0 0 0 0 1; SSR 0 0 1;
  LOOP I 1 NUM;
    SR X|I 0 0 0 0 0 0 0 1; SSR 0 0 1;
    SR 0 0 X|I 0 0 0 0 0 1; SSR 0 0 1;
    SR 0 0 0 0 0 (X|I)/10 0 0 1; SSR 0 0 1;
  ENDLOOP;
ENDPROCEDURE;

PROCEDURE MAIN;
  VARIABLE WHERE 100;
  {LATTICE ARGUMENTS}
  VARIABLE KS 1 2; VARIABLE X  1 2;
  VARIABLE XS 1 4; VARIABLE XM 1 4;
  {for TREL}
  VARIABLE MAPPARAMS 1 12; {HOLDS THE ABOVE VALUES}
  VARIABLE MAPARR 1000 6 543; VARIABLE SPNRARR 1000 3 3 543;
  VARIABLE VRF 1 1 1;
  VARIABLE FREQ 1;
  VARIABLE HNUM 1;
  VARIABLE RFFLAG 1; VARIABLE NSEQ 1; {number of elements in lattice}

  RFFLAG := 1;
  NSEQ := 542;
  HNUM := 66;
  VRF(1, 1) := 100/HNUM; {RF Voltage [kV]}
  FREQ := HNUM*REVFREQ(ACCLEN(1)); {RF Frequency}
  
  DIRSET WHERE 'data/TEST/FIRST-ST/SEQ/';
  GROUTF 'img/dump/TR' 1;
  
  
  OV 5 3 0;
  { SET FOR PROTONS }
  SET_FOR_PROTONS 130 X XM XS;
  NAVIGATORS 0 0 1 KS;     {NAVIGATORS are OFF; pure FS lattice}
  MAPPARAMS(1) := X(1);   MAPPARAMS(2) := X(2);   {X}
  MAPPARAMS(3) := XM(1);  MAPPARAMS(4) := XM(2);  {XM}
  MAPPARAMS(5) := XM(3);  MAPPARAMS(6) := XM(4);
  MAPPARAMS(7) := XS(1);  MAPPARAMS(8) := XS(2);  {XS}
  MAPPARAMS(9) := XS(3);  MAPPARAMS(10) := XS(4);
  MAPPARAMS(11):= KS(1);  MAPPARAMS(12) := KS(2); {KS}
  
  LATTICE MAPPARAMS MAPARR SPNRARR;
  IF RFFLAG=1;
    UM; RF VRF 0 FREQ 0 0.05;
    INSERT 1 MAPARR SPNRARR NSEQ;
    NSEQ := NSEQ + 1;
  ENDIF;
  OPENF 636 WHERE&'TRANSFER_MAP' 'REPLACE';
  PM 636; CLOSEF 636;

  INJECT 10;
  WRITE 6 '******************** STARTING TRACKING';
  OPENF 99 WHERE&'PRAY.dat' 'REPLACE';
  PRAY 99; CLOSEF 99;
  OPENF 772 WHERE&'TRPRAY.dat' 'REPLACE';
  OPENF 893 WHERE&'TRPSPI.dat' 'REPLACE';
  TRPRAY 772; TRPSPI 893;
  TREL MAPARR SPNRARR 1 NSEQ 5 772 893;
  CLOSEF 772; CLOSEF 893;

ENDPROCEDURE; {MAIN}

PROCEDURE RUN;
  MAIN;
ENDPROCEDURE;
RUN; END;
