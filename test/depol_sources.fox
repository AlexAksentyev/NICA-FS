INCLUDE 'bin/setups/BENDS24/SEQFULL';

PROCEDURE INJECT NUM SX SY SZ;
  VARIABLE X 100; VARIABLE I 1;
  CR;
  X := LINSPACE(-5E-3, 5E-3, NUM);
  SR 0 0 0 0 0 0 0 0 1; SSR 0 0 1;
  LOOP I 1 NUM;
    SR X|I 0 0 0 0 0 0 0 1; SSR SX SY SZ;
    SR 0 0 X|I 0 0 0 0 0 1; SSR SX SY SZ;
    SR 0 0 0 0 0 (X|I)/10 0 0 1; SSR SX SY SZ;
  ENDLOOP;
ENDPROCEDURE;

PROCEDURE RUN;
  VARIABLE WHERE 100;
  VARIABLE HZ1 1; VARIABLE HZ2 1;
  VARIABLE KZ1 1; VARIABLE KZ2 1;
  VARIABLE QF  1; VARIABLE QD  1;
  VARIABLE MAPPARAMS 1 6; {HOLDS THE ABOVE VALUES}
  VARIABLE MAPARR 1000 6 472; VARIABLE SPNRARR 1000 3 3 472;
  {RF parameters}
  VARIABLE VRF 1 1 1;
  VARIABLE FREQ 1;
  VARIABLE HNUM 1;

  DIRSET WHERE 'data/DEPOL_SOURCES/WITHRF/LONGITUDINAL_SPIN/';
  GROUTF 'img/dump/TR' 1;

  OV 3 3 0;
  SET_FOR_DEUTERONS HZ1 HZ2 QF QD;
  MAPPARAMS(1) := HZ1; MAPPARAMS(2) := HZ2;
  MAPPARAMS(3) := KZ1; MAPPARAMS(4) := KZ2;
  MAPPARAMS(5) := QF;  MAPPARAMS(6) := QD;

  LATTICE MAPPARAMS MAPARR SPNRARR;
  
  {SETTING RF PARAMETERS}
  HNUM := 66;
  VRF(1, 1) := 100/HNUM; {RF Voltage [kV]}
  FREQ := HNUM*REVFREQ(ACCLEN(1)); {RF Frequency}
  UM; RF VRF 0 FREQ 0 0.05;
    INSERT 1 MAPARR SPNRARR 471;
  INJECT 30 0 0 1; { .25 .25 SQRT(1 - 2*.25*.25); }
  OPENF 7 WHERE&'TRPRAY:TREL.dat' 'REPLACE';
  OPENF 8 WHERE&'TRPSPI:TREL.dat' 'REPLACE';
  TREL MAPARR SPNRARR 1 472 1 7 8 0;
  CLOSEF 7; CLOSEF 8;
  
  WRITE 6 'SUCCESS!';

ENDPROCEDURE; {RUN}

RUN; END;

