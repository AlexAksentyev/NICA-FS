INCLUDE 'bin/support/support';

PROCEDURE RUN;
  VARIABLE RESTMASSAMU 1; VARIABLE GAMMA 1; VARIABLE EKIN 1;
  VARIABLE WHERE 100;
  VARIABLE QF  1; VARIABLE QD  1;
  VARIABLE HZ1 1; VARIABLE HZ2 1;
  VARIABLE KZ1 1; VARIABLE KZ2 1;
  VARIABLE MAPPARAMS 1 6; {HOLDS THE ABOVE VALUES}
  VARIABLE MAPARR 1000 6 471; VARIABLE SPNRARR 1000 3 3 471;

  VARIABLE PCL 2 2; VARIABLE PID 1;

  VARIABLE L_Q 1; VARIABLE GF 1; VARIABLE GD 1;
  VARIABLE L_O 1; VARIABLE L_D 1; VARIABLE PHI 1;
  VARIABLE OBJ 1;

  DIRSET WHERE 'data/TEST/' TRUE;
  GROUTF 'img/dump/TR' 1;
  PCL(1) := 1.00728&1.792847; {proton rest mass and G}
  PCL(2) := 2.01410&(-.142987); {deuteron rest mass and G}
  
  OV 1 3 0; PID := 2;
  RESTMASSAMU := PCL(PID)|1;
  GAMMA := 1.14;
  EKIN := (GAMMA-1)*RESTMASSAMU*AMUMEV;
  WRITE 6 'EKIN = '&ST(EKIN);
  RP EKIN RESTMASSAMU 1;
  RPS 1 PCL(PID)|2;

  {LATTICE PARAMETERS:}
  IF M0<2; SET_FOR_PROTONS HZ1 HZ2 QF QD; WRITE 6 'SETUP FOR PROTONS';
  ELSEIF TRUE; SET_FOR_DEUTERONS HZ1 HZ2 QF QD; WRITE 6 'SETUP FOR DEUTERONS';
  ENDIF;
  
  { BENDS24_SETUP HZ1 HZ2 KZ1 KZ2 QF QD 0; }
  { OPENF 935 WHERE&'MAP' 'REPLACE'; PM 935; CLOSEF 935; }

  { MAPPARAMS(1) := HZ1; MAPPARAMS(2) := HZ2; }
  { MAPPARAMS(3) := KZ1; MAPPARAMS(4) := KZ2; }
  { MAPPARAMS(5) := QF;  MAPPARAMS(6) := QD; }

  { MAPSEQ24BENDS_SELECT MAPARR SPNRARR; }
  CW_SETUP 0 0 0 ZEROS(32);
  
{   L_O := .1; L_D := 1; L_Q := .1; }
{   GF  := -37 + 0*.08*10/CONS(CHIM); }
{   GD := 32 + 0*(-.28*10/CONS(CHIM)); }
{   PHI := 25.714285714285715*DEGRAD; }
{   SB .15 .15 0 .15 .15 0 0 0 0 0 0; }
{   pty 0; }
{   FIT GF GD; }
{   UM; CR; ER 1 3 1 3 1 1 1 1; }
{   BP; }
{ simple; }
{   EP; }
{   PG -1 -2; }
{   OBJ := ABS(ME(1,2)) + ABS(ME(3,4)); }
{   WRITE 6 GF GD OBJ; }
{   ENDFIT 1E-8 1000 1 OBJ; }

{ WRITE 6 'CHIM = '&ST(CONS(CHIM)); }
{ QUIT 0; }
{   SIMPLE ; }

  INJECT_LIKE_MADX;
  
  OPENF 924 WHERE&'TRPRAY.dat' 'REPLACE';
  OPENF 925 WHERE&'TRPSPI.dat' 'REPLACE';
    { TREL MAPARR SPNRARR 1 471 1 924 925 0; }
    TRPRAY 924; TRPSPI 925;
    TR 1000 1 -1 -3 1.2 1.2 0 0 -12;
  CLOSEF 924; CLOSEF 925;
  
  WRITE 6 'SUCCESS!';

ENDPROCEDURE; {RUN}

RUN; END;

