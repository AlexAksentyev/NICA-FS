INCLUDE 'bin/setups/BENDS3/FULL';

PROCEDURE INJECT NUM;
  VARIABLE X 100; VARIABLE I 1;
  X := LINSPACE(-1E-3, 1E-3, NUM);
  SR 0 0 0 0 0 0 0 0 1; SSR 0 0 1;
  LOOP I 1 NUM;
    SR X|I 0 0 0 0 0 0 0 1; SSR 0 0 1;
    SR 0 0 X|I 0 0 0 0 0 1; SSR 0 0 1;
    SR 0 0 0 0 0 (X|I)/10 0 0 1; SSR 0 0 1;
  ENDLOOP;
ENDPROCEDURE;

PROCEDURE MAIN;
  VARIABLE WHERE 100;
  VARIABLE Hz1 1; VARIABLE Hz2 1;
  VARIABLE rHz1 1; VARIABLE rHz2 1;
  VARIABLE QF 1;  VARIABLE QD 1;
  VARIABLE MAPPARAMS 1 6; {HOLDS THE ABOVE VALUES}
  VARIABLE MAPARR 1000 6 615; VARIABLE SPNRARR 1000 3 3 615;
  VARIABLE VRF 1 1 1;
  VARIABLE FREQ 1;
  VARIABLE HNUM 1;
  DIRSET WHERE 'data/TEST/';
  GROUTF 'img/dump/TR' 1;
  
  
  OV 3 3 0;
  SET_FOR_PROTONS HZ1 HZ2 QF QD;
  NAVIGATORS 1e-2*0 0 1 rHz1 rHz2;
  MAPPARAMS(1) := HZ1;  MAPPARAMS(2) := HZ2;
  MAPPARAMS(3) := rHz1*HZ1; MAPPARAMS(4) := rHz2*HZ2;
  MAPPARAMS(5) := QF;   MAPPARAMS(6) := QD;

  LATTICE Hz1 Hz2 rHz1*HZ1 rHz2*HZ2 QF QD 1; {for non-seq tracking}
  HNUM := 66;
  VRF(1, 1) := 100/HNUM; {RF Voltage [kV]}
  FREQ := HNUM*REVFREQ(ACCLEN(1)); {RF Frequency}
  { LATTICE MAPPARAMS MAPARR SPNRARR; }
  { UM; RF VRF 0 FREQ 0 0.05; }
  { INSERT 1 MAPARR SPNRARR 614; }
  OPENF 636 WHERE&'PM.map' 'REPLACE';
  PM 636; CLOSEF 636;

  INJECT 10;
  WRITE 6 '******************** STARTING TRACKING';
  OPENF 99 WHERE&'PRAY.dat' 'REPLACE';
  PRAY 99; CLOSEF 99;
  OPENF 772 WHERE&'TRPRAY.dat' 'REPLACE';
  OPENF 893 WHERE&'TRPSPI.dat' 'REPLACE';
  TRPRAY 772; TRPSPI 893;
  TR 600000 NINT(600000/5000) -1 -3 1.2 1.2 0 0 -12;
  { TREL MAPARR SPNRARR 1 615 10 772 893; }
  CLOSEF 772; CLOSEF 893;

ENDPROCEDURE; {MAIN}

PROCEDURE RUN;
  MAIN;
ENDPROCEDURE;
RUN; END;
