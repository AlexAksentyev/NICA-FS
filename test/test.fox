INCLUDE 'bin/setups/NICA_FS';

PROCEDURE RUN;
  VARIABLE WHERE 100; VARIABLE SUBDIR 100;
  VARIABLE Q1 1 ; VARIABLE Q2 1 ; VARIABLE OBJ 1 ;
  VARIABLE LDIP 1; VARIABLE RDIP 1; VARIABLE PHDIP 1;
  VARIABLE TILT 1;
  VARIABLE TESTPIC 10000;
  VARIABLE MU 800; VARIABLE NBAR 800 3; VARIABLE MUARR 800 4;
  PROCEDURE GEST MUARR;
    VARIABLE K 1;
    MUARR(1) := MU; LOOP K 1 3; MUARR(K+1) := NBAR(K); ENDLOOP;
    POLVAL 1 MUARR 4 RAY TWOND MUARR 4;
  ENDPROCEDURE;
  PROCEDURE INJECT NUM;
    VARIABLE X 100; VARIABLE I 1;

    OPENF 100500 WHERE&'X.in' 'REPLACE';
    X := LINSPACE(-1, 1, NUM);
    CR;
    LOOP I 1 NUM;
      SR X|I 0 0 0 0 0 0 0 1; SSR 0 0 1;
      SR 0 0 X|I 0 0 0 0 0 1; SSR 0 0 1;
      WRITE 100500 X|I;
    ENDLOOP;
    CLOSEF 100500;
  ENDPROCEDURE; {INJECT}
  PROCEDURE TRACK PNTNUM STEP MARK;
    VARIABLE TURN 1; VARIABLE PNT 1; VARIABLE PCT 1;

    OPENF 100500 FILENAME(SUBDIR, 'PRAY', 'RUN'&MARK) 'REPLACE';
    PRAY 100500; CLOSEF 100500;

    OPENF 100500 FILENAME(SUBDIR, 'STUNEE', 'RUN'&MARK) 'REPLACE';
    WRITE 100500 '# TSS OUTPUT DA VECTORS EVALUATED @ CURRENT PHASE SPACE POINT';
    WRITE 100500 'TURN PID NU NX NY NZ';
    { GEST MUARR; }
    WRITETBL 100500 MUARR 4 SF(0, '(I15)');
    WRITE 6 si(0)&' %';
    OPENF 100501 FILENAME(SUBDIR, 'TRPSPI', 'RUN'&MARK) 'REPLACE';
    WRITE 100501 '# TRACKING OUTPUT';
    WRITE 100501 'TURN PID S_X S_Y S_Z';
    WRITETBL 100501 SPI 3 SF(0, '(I15)');
    OPENF 100502 FILENAME(SUBDIR, 'TRPRAY', 'RUN'&MARK) 'REPLACE';
    WRITE 100502 '# TRACKING OUTPUT';
    WRITE 100502 'TURN PID X A Y B T D';
    WRITETBL 100502 RAY 6 SF(0, '(I15)');

    TRR 1;
    LOOP PNT 1 PNTNUM; TURN := STEP*PNT;
      TR STEP -STEP -1 -3 1.1 1.1 0 0 -12;
      { GEST MUARR; }
      WRITETBL 100500 MUARR 4 SF(TURN, '(I15)');
      WRITETBL 100501 SPI 3 SF(TURN, '(I15)');
      WRITETBL 100502 RAY 6 SF(TURN, '(I15)');
      PCT := 100*PNT/PNTNUM;
      IF MOD(PCT, 10)=0; WRITE 6 SI(PCT)&' %'; ENDIF;
    ENDLOOP;

    CLOSEF 100500; CLOSEF 100501; CLOSEF 100502;
  ENDPROCEDURE; {TRACK}
  PROCEDURE WRITETSS;
    VARIABLE K 1;
    OPENF 100500 SUBDIR&'NU.da' 'REPLACE'; WRITE 100500 MU; CLOSEF 100500;
    LOOP K 1 3;
      OPENF 100500 SUBDIR&'NBAR'&MRK(K)&'.da' 'REPLACE';
      WRITE 100500 NBAR(K); CLOSEF 100500;
    ENDLOOP;
  ENDPROCEDURE; {WRITETSS}
  PROCEDURE WRITEMAPS;
    VARIABLE I 1; VARIABLE J 1;
    LOOP I 1 TWOND;
    OPENF 100500 SUBDIR&'MAP'&MRK(I)&'.da' 'REPLACE';
      WRITE 100500 MAP(I); CLOSEF 100500;
    ENDLOOP;
    LOOP I 1 3; LOOP J 1 3;
      OPENF 100500 SUBDIR&'SPNR_'&MRK(I)&'_'&MRK(J)&'.da' 'REPLACE';
        WRITE 100500 SPNR(I,J); CLOSEF 100500;
    ENDLOOP; ENDLOOP;
  ENDPROCEDURE; {WRITEMAPS}
  PROCEDURE TRIPLET A B;
    MQ .1 A .05; DL .05; MQ .1 -B .05; DL .05; MQ .1 A .05;
  ENDPROCEDURE; {TRIPLET}


  DIRSET WHERE 'data/TEST/'; SUBDIR := WHERE;
  GROUTF 'img/dump/TR' 1;

  OV 1 3 0;
  RP 270 1876.5592/AMUMEV 1;
  RPS 1 -.142987;
  { FR 0; }

  PTY 1;
  OPENF 7 WHERE&'OUTPUT.TXT' 'REPLACE';

  RDIP := 10;
  PHDIP := 30;
  LDIP := RDIP*PHDIP*DEGRAD;
  TILT := 90;
  UM ; CR ; {clears the rays}
  { CB ; }
  { ER 1 3 1 3 1 1 1 1 ; }
  { SR 0 1e-2 0 0 0 0 0 0 7; SSR 0 0 1; }
  SR .25 0 0 0 0 0 0 0 2; SSR 0 0 1;
  SR 0 0 .25 0 0 0 0 0 3; SSR 0 0 1;
  WRITE 6 RAY(3);
  BP ; {begins a picture}
  DL LDIP ;
  RA -TILT; DI RDIP PHDIP .5 -30 0 -30 0; RA TILT;
  { DP RDIP PHDIP .5; }
  { DP RDIP PHDIP .5; }
  { TRIPLET Q1 Q2 ; DL LDIP ; }
  { DP RDIP PHDIP .5; }
  { DP RDIP PHDIP .5; }
  DL LDIP;
  EP ; {ends the picture}
  {PP -2 0 90 ;} {outputs the x,y pictures to default windows}
  {PP -1 0 0; }
  PG -1 -2;
  CLOSEF 7;
  WRITE 6 RAY(3);

  { WRITEMAPS; }
  { TSS MU NBAR 0; WRITETSS; }
  { INJECT 10; }
  { TRACK 40 1 ''; }
  

ENDPROCEDURE; {RUN}

RUN; END;
