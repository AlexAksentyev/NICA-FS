INCLUDE 'bin/elements';

PROCEDURE RUN;
  VARIABLE WHERE 100;
  VARIABLE TILT 1;
  VARIABLE MAPARR 10000 6 18; VARIABLE SPNRARR 10000 3 3 18;
  PROCEDURE INJECT NUM;
    VARIABLE X 100; VARIABLE I 1;
    X := LINSPACE(-1e-3, 1e-3, NUM);
    CR;
    LOOP I 1 NUM;
      SR X|I 0 0 0 0 0 0 0 1; SSR 0 1 0;
      SR 0 0 X|I 0 0 0 0 0 1; SSR 0 1 0;
    ENDLOOP;
  ENDPROCEDURE; {INJECT}
  PROCEDURE TRIPLET A B;
    QUAD .1 A; DL .5; QUAD .1 -B; DL .5; QUAD .1 A;
  ENDPROCEDURE; {TRIPLET}


  DIRSET WHERE 'data/TEST/';
  GROUTF 'img/dump/TR' 1;

  TILT:=90;

  OV 1 3 0;
  RP 270 1876.5592/AMUMEV 1;
  RPS 1 -.142987;

  {COMPUTING LATTICE MAPS}
  UM; DL 1;
  SMAPS 1 MAPARR SPNRARR;
  SMAPS 3 MAPARR SPNRARR;
  UM; { SOLENOID .7 1; } SBEND 1 90 TILT;
  SMAPS 2 MAPARR SPNRARR;
{  UM; TRIPLET H1 H2 ;
  SMAPS 4 MAPARR SPNRARR;}

  INJECT 10;
 WRITE 6 RAY(1);
  OPENF 7 FILENAME(WHERE, 'TRPRAY', 'TREL') 'REPLACE';
  OPENF 8 FILENAME(WHERE, 'TRPSPI', 'TREL') 'REPLACE';
  TREL MAPARR SPNRARR 3 10 7 8;
  CLOSEF 7; CLOSEF 8;
  WRITE 6 RAY(1);
  TRACK 100 1 WHERE '';
  
  WRITE 6 'SUCCESS!';

ENDPROCEDURE; {RUN}

RUN; END;

