INCLUDE 'bin/elements';

PROCEDURE RUN;
  VARIABLE WHERE 100; VARIABLE SUBDIR 100; VARIABLE ANSWER 3;
  VARIABLE Q 1 ; VARIABLE QT 1; VARIABLE TILT 1;
  VARIABLE H1 1 ; VARIABLE H2 1; VARIABLE OBJ 1 ;
  VARIABLE MAPARR 10000 6 18; VARIABLE SPNRARR 10000 3 3 18; VARIABLE CNT 1;
  PROCEDURE INJECT NUM;
    VARIABLE X 100; VARIABLE I 1;

    OPENF 100500 WHERE&'X.in' 'REPLACE';
    X := LINSPACE(-1e-3, 1e-3, NUM);
    CR;
    LOOP I 1 NUM;
      SR X|I 0 0 0 0 0 0 0 1; SSR 0 0 1;
      SR 0 0 X|I 0 0 0 0 0 1; SSR 0 0 1;
      WRITE 100500 X|I;
    ENDLOOP;
    CLOSEF 100500;
  ENDPROCEDURE; {INJECT}
  PROCEDURE TRACK PNTNUM STEP MARK;
    VARIABLE TURN 1; VARIABLE PNT 1; VARIABLE PCT 1;

    OPENF 100500 FILENAME(SUBDIR, 'PRAY', 'RUN'&MARK) 'REPLACE';
    PRAY 100500; CLOSEF 100500;
    WRITE 6 SI(0)&' %';
    OPENF 100501 FILENAME(SUBDIR, 'TRPSPI', 'RUN'&MARK) 'REPLACE';
    WRITE 100501 '# TRACKING OUTPUT';
    WRITE 100501 'TURN PID S_X S_Y S_Z';
    WRITETBL 100501 SPI 3 SF(0, '(I15)');
    OPENF 100502 FILENAME(SUBDIR, 'TRPRAY', 'RUN'&MARK) 'REPLACE';
    WRITE 100502 '# TRACKING OUTPUT';
    WRITE 100502 'TURN PID X A Y B T D';
    WRITETBL 100502 RAY 6 SF(0, '(I15)');

    TRR 1;
    LOOP PNT 1 PNTNUM; TURN := STEP*PNT;
      TR STEP -STEP -1 -3 1.1 1.1 0 0 -12;
      WRITETBL 100501 SPI 3 SF(TURN, '(I15)');
      WRITETBL 100502 RAY 6 SF(TURN, '(I15)');
      PCT := 100*PNT/PNTNUM;
      IF MOD(PCT, 10)=0; WRITE 6 SI(PCT)&' %'; ENDIF;
    ENDLOOP;

    CLOSEF 100500; CLOSEF 100501; CLOSEF 100502;
  ENDPROCEDURE; {TRACK}
  PROCEDURE TRIPLET A B;
    MQ .1 A .05; DL .05; MQ .1 -B .05; DL .05; MQ .1 A .05;
  ENDPROCEDURE; {TRIPLET}
  PROCEDURE CELL0 ;
    DL .1;
    DP 1 45 .05;
    DL .1;
    QUAD .1 -.1;
    DL .1;
  ENDPROCEDURE; { CELL0 }
  PROCEDURE CELL_BEND;
    DI 10 20 .1 0 0 0 0;
  ENDPROCEDURE; { CELL_BEND }
  PROCEDURE CELL Q H1 H2;
    DL .3; CELL_BEND; DL .1; MH .1 H1 .05;
    DL .1; MQ .1 Q .05; DL .3; MH .1 H2 .05;
  ENDPROCEDURE; { CELL }
  PROCEDURE TILTED_BEND R0 PHI0 TILT;
    IF TILT=0; DL R0*PHI0;
    ELSEIF LO(1);
      ROTATE -TILT;
          DI R0 PHI0 .1 0 0 0 0;
      ROTATE TILT;
    ENDIF;
  ENDPROCEDURE; {TILTED_BEND}
  PROCEDURE TILTED_CELL Q TILT;
    VARIABLE Y0 1; VARIABLE L0 1;
    Y0:=5E-3; L0:=.5;
    DL .2; CELL_BEND; DL .2;
    TILTED_BEND L0 Y0 TILT; DL .2;
  ENDPROCEDURE; {TILTED_CELL}
  PROCEDURE HALFRING Q H1 H2 ;
    VARIABLE I 1;
    LOOP I 1 9 ; CELL Q H1 H2 ; ENDLOOP ;
  ENDPROCEDURE; { HALFRING }
  PROCEDURE OPTIMIZE Q1 Q2;
    SB .15 .15 0 .15 .15 0 0 0 0 0 0 ;
    FIT Q1 Q2;
      UM; CR;
      ER 1 4 1 4 1 1 1 1 ;
      BP ;
      TRIPLET Q1 Q2;
      EP ;
      PG -1 -2 ; {outputs the x,y pictures to default windows}
      OBJ := ABS(ME(1,2))+ABS(ME(3,4)) ;
    ENDFIT 1E-5 100 1 OBJ ;
    WRITE 6 Q OBJ;
  ENDPROCEDURE; {OPTIMIZE}
  PROCEDURE PLOT ;
    UM ; CR ; {clears the rays}
    SR 5E-3 0 0 0 0 0 0 0 2; SSR 0 0 1;
    SR 0 0 5E-3 0 0 0 0 0 3; SSR 0 0 1;

    WRITE 6 'PLOT';
    BP ; 
      DL 5;
      CELL_BEND;
      DL .1;
      TILTED_BEND 10 90 TILT;
      DL 25;
    EP ; 
    PG -1 -2;
  ENDPROCEDURE; {PLOT}


  DIRSET WHERE 'data/TEST/'; SUBDIR := WHERE;
  GROUTF 'img/dump/TR' 1;

  OV 1 3 0;
  RP 270 1876.5592/AMUMEV 1;
  RPS 1 -.142987;

  PTY 100;
  TILT:=90;

  OPTIMIZE H1 H2;

  {COMPUTING LATTICE MAPS}
  UM; DL 1;
  SMAPS 1 MAPARR SPNRARR;
  SMAPS 3 MAPARR SPNRARR;
  {LOOP CNT 1 9;
    SMAPS CNT MAPARR SPNRARR;
  ENDLOOP;
  LOOP CNT 11 18;
    SMAPS CNT MAPARR SPNRARR;
  ENDLOOP;}
  UM; TILTED_BEND 1 30 TILT;
  SMAPS 2 MAPARR SPNRARR;
  UM; TRIPLET H1 H2 ;
  SMAPS 4 MAPARR SPNRARR;

  INJECT 10;
  WRITE 6 RAY(1);
  OPENF 7 FILENAME(SUBDIR, 'TRPRAY', 'RUN') 'REPLACE';
  OPENF 8 FILENAME(SUBDIR, 'TRPSPI', 'RUN') 'REPLACE';
  TREL MAPARR SPNRARR 3 100 7 8;
  CLOSEF 7; CLOSEF 8;
  WRITE 6 RAY(1);
  
  WRITE 6 'SUCCESS!';
ENDPROCEDURE; {RUN}

RUN; END;
